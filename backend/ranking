USE habits_db;
SELECT u.username,
       COALESCE(SUM(CASE WHEN l.value=1 THEN 1 ELSE 0 END),0) AS done_days
FROM users u
JOIN profiles p ON p.user_id=u.id AND p.is_public=1
LEFT JOIN habits h ON h.user_id=u.id
LEFT JOIN logs l   ON l.habit_id=h.id
                  AND l.day BETWEEN CURDATE() - INTERVAL 6 DAY AND CURDATE()
GROUP BY u.id, u.username
ORDER BY done_days DESC, u.username ASC;
